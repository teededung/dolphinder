<!-- f86a850b-3486-4e91-a2b0-312f03b6f504 b7fa2c39-1fa9-428c-8cff-8bc65cd35fee -->
# Kế hoạch: On-chain Developer Profiles (Sui Testnet) + Walrus + Gasless

## 1) Xác nhận nền tảng hiện tại

- Hợp đồng đã publish: `developer_registry::registry` (testnet) và đã chạy `init_registry`.
- Biến môi trường đã có: `PACKAGE_ID`, `USERNAME_INDEX_ID`, `ADMIN_CAP_ID`, `SPONSOR_PRIVATE_KEY`, `SPONSOR_ADDRESS`, `WALRUS_PUBLISHER_URL`, `WALRUS_AGGREGATOR_URL`, `SUI_RPC_URL`.
- Username index: `Table<u64, ID>` (hash FNV-1a trên username bytes).

## 2) RPC & Walrus

- RPC: dùng `SUI_RPC_URL` ở backend (ổn định) và `getFullnodeUrl("testnet")` ở frontend (nếu cần).
- Walrus: tách 2 endpoint trong env:
- Ghi (publisher): `WALRUS_PUBLISHER_URL`
- Đọc (aggregator): `WALRUS_AGGREGATOR_URL`
- Lưu `blobId` dưới dạng chuỗi UTF‑8; chuyển thành `vector<u8>` khi gửi vào Move call.

## 3) API sponsor gasless (Astro API)

- File: `src/pages/api/sponsor/execute.ts`
- Input: `{ txBytes, userSignature, sender }`
- Luồng:
- Xác thực chữ ký user và `sender`.
- Whitelist: module `developer_registry::registry` và các entry `register`, `update_profile`, `set_verification`.
- Ký bổ sung bằng `SPONSOR_PRIVATE_KEY`, ghép chữ ký `[userSig, sponsorSig]`, `executeTransactionBlock` tại `SUI_RPC_URL`.
- Bảo mật: rate-limit, CORS, kiểm tra gasBudget hợp lý.

## 4) Walrus utils

- File: `src/lib/walrus.ts`
- `uploadJson(obj) → Promise<string>`: gọi `WALRUS_PUBLISHER_URL`, trả `blobId` (string).
- `fetchJson(blobId) → Promise<any>`: gọi `WALRUS_AGGREGATOR_URL` đọc blob.

## 5) Sui views & tx builders

- File: `src/lib/sui-views.ts`
- `getDevIdByUsername(username) → Promise<string|null>`: dùng `devInspect` gọi view `get_dev_id_by_username(USERNAME_INDEX_ID, usernameBytes)`. Trả `objectId` hoặc `null`.
- File: `src/lib/sui-tx.ts`
- `buildRegisterTx(usernameBytes, blobIdBytes)` → Transaction (moveCall `register` với `USERNAME_INDEX_ID`).
- `buildUpdateProfileTx(devObjectId, blobIdBytes)` → Transaction (moveCall `update_profile`).

## 6) Forms & luồng cập nhật

- Thư mục: `src/components/onchain/`
- `OnchainProfileForm.tsx`: cập nhật trường profile (name, bio, github, linkedin, website, avatarUrl).
- `ProjectForm.tsx`: thêm dự án (name, description, repoUrl, demoUrl, tags[]).
- `CertificateForm.tsx`: thêm chứng chỉ (title, issuer, date, url, credentialId).
- Quy trình submit dùng chung:
1) Tra `devId` qua `getDevIdByUsername` → nếu có thì fetch object → lấy `walrus_blob_id` → `fetchJson`.
2) Merge thay đổi trong JSON → `uploadJson` → nhận `blobId` mới.
3) Build tx: nếu chưa có dev → `register`; nếu đã có → `update_profile`.
4) Wallet ký → gửi `{ txBytes, userSignature, sender }` tới `/api/sponsor/execute` (gasless).

## 7) Hiển thị profile on-chain

- `src/components/onchain/OnchainProfile.tsx`:
- Tra `devId` → fetch object → lấy `walrus_blob_id` → `fetchJson(blobId)` → render.
- Fallback: `src/data/developers/{username}.json` nếu không có on-chain.
- Tích hợp vào `src/pages/[username]/index.astro` (client:load), giữ UI hiện có.

## 8) Trang admin verify

- `src/pages/admin/verify.astro` + `VerifyForm.tsx`:
- Tra `devId` qua view.
- Gọi `set_verification(dev, true, &AdminCap)` bằng ví admin (nắm `AdminCap`); có thể dùng sponsor để trả gas.

## 9) Seed/migration (tuỳ chọn)

- `scripts/seed_onchain.ts`: đọc dữ liệu tĩnh → upload Walrus → `register` gasless theo nhu cầu.

## 10) Kết quả/Deliverables

- API sponsor hoạt động (gasless) cho `register/update_profile/set_verification`.
- Walrus utils (publisher/aggregator) hoàn chỉnh.
- Dashboard có 3 form (profile/project/certificate) cập nhật on-chain.
- Trang profile ưu tiên on-chain, fallback tĩnh.
- Trang admin verify builder.

### To-dos

- [x] Khởi tạo Move package developer_registry và module registry
- [x] Publish Move package lên Sui testnet, lấy IDs (PACKAGE/INDEX/ADMIN_CAP)
- [ ] Tạo API sponsor/execute xử lý txBytes + userSignature
- [ ] Tạo util walrus uploadJson/fetchJson, đọc env WALRUS_URL
- [ ] Tạo OnchainProfileForm cập nhật phần profile
- [ ] Tạo ProjectForm thêm dự án vào JSON rồi update_profile
- [ ] Tạo CertificateForm thêm chứng chỉ rồi update_profile
- [ ] Trang dashboard.astro hiển thị 3 form và trạng thái on-chain
- [ ] OnchainProfile component + tích hợp vào [username]/index.astro
- [ ] Trang admin verify với VerifyForm gọi set_verification
- [ ] Giữ fallback dữ liệu tĩnh khi thiếu on-chain
- [ ] Script seed dữ liệu tĩnh lên Walrus và register on-chain