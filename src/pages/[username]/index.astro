---
import { loadDevelopers } from "../../data/loadDevs";
import MainLayout from "../../components/MainLayout.astro";
import ProfileCard from "../../components/shared/ProfileCard";
import OnchainProfile from "../../components/onchain/OnchainProfile";
import { createSupabaseServerClient } from "../../lib/supabase/serverClient";
import { getDeveloperByUsername, getCurrentUser } from "../../lib/auth";

export const prerender = false;

const { username } = Astro.params;

// Try to get from Supabase first
const supabase = createSupabaseServerClient(Astro.cookies as any);
const currentUser = await getCurrentUser(supabase);
let developer = await getDeveloperByUsername(supabase, username || '');

// Check if user can view this profile
if (developer) {
  // Profile exists in Supabase
  const isOwner = currentUser && currentUser.id === developer.user_id;
  const isVerified = developer.is_verified;

  // Only show if verified OR if owner viewing their own profile
  if (!isVerified && !isOwner) {
    return Astro.redirect('/developers');
  }
}

// Fallback to JSON if not found in Supabase
let dev: any;
if (!developer) {
  const developers = await loadDevelopers();
  dev = developers.find(d => d.username === username);
  
  if (!dev) {
    return Astro.redirect('/developers');
  }
} else {
  // Map database structure to component props
  dev = {
    name: developer.name,
    username: developer.username,
    avatar: developer.avatar || '',
    bio: developer.bio || '',
    github: developer.github || '',
    linkedin: developer.linkedin || '',
    telegram: developer.telegram || '',
    slushWallet: developer.slush_wallet || '',
    entry: developer.entry || '',
  };
}
---

<MainLayout title={`${dev.name} - Developer Profile`}>
  <div class="min-h-screen pt-20">
    <div class="container mx-auto px-4 py-8">
      <!-- Profile Card -->
      <div class="max-w-2xl mx-auto">
        <div class="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 p-8 text-center">
          <div id="static-profile" style="display:none">
            <ProfileCard
              client:only="react"
              variant="offchain"
              name={dev.name}
              username={dev.username}
              avatar={dev.avatar}
              bio={dev.bio}
              github={dev.github}
              linkedin={dev.linkedin}
              website={dev.website}
              walletAddress={dev.slushWallet}
            />
          </div>

          <!-- On-chain profile overlay (Walrus JSON) -->
          <div id="onchain-profile">
            <OnchainProfile client:only="react" username={dev.username} />
          </div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
