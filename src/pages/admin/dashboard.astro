---
import MainLayout from "../../components/MainLayout.astro";
import LogoutButton from "../../components/shared/LogoutButton";
import ProfileAvatar from "../../components/shared/ProfileAvatar";
import ActionButton from "../../components/admin/ActionButton";
import {
  createSupabaseServerClient,
  createSupabaseAdminClient,
} from "../../lib/supabase/serverClient";
import {
  getCurrentUser,
  isAdmin,
  getPendingDevelopers,
  getVerifiedDevelopers,
} from "../../lib/auth";

export const prerender = false;

// Check authentication
const supabase = createSupabaseServerClient(Astro.cookies as any);
const user = await getCurrentUser(supabase);

if (!user) {
  return Astro.redirect("/admin/login");
}

// Check if user is admin
if (!isAdmin(user.email)) {
  return new Response("Forbidden", { status: 403 });
}

// Fetch developers using admin client (bypasses RLS)
const adminClient = createSupabaseAdminClient();
const pendingDevelopers = await getPendingDevelopers(adminClient);
const verifiedDevelopers = await getVerifiedDevelopers(adminClient);

console.log("[Admin Dashboard] Pending developers:", pendingDevelopers.length);
console.log(
  "[Admin Dashboard] Verified developers:",
  verifiedDevelopers.length
);
---

<MainLayout title="Admin Dashboard">
  <div class="min-h-screen pt-20">
    <div class="container mx-auto px-4 py-8">
      <div class="mb-8 flex items-center justify-between">
        <h1 class="text-3xl font-bold">Admin Dashboard</h1>
        <div class="flex items-center gap-4">
          <span class="text-muted-foreground text-sm">
            {user.email}
          </span>
          <LogoutButton client:load />
        </div>
      </div>

      <div class="mb-8 grid gap-4 md:grid-cols-3">
        <div class="bg-card rounded-lg border p-6">
          <h3 class="text-muted-foreground text-sm font-medium">
            Pending Review
          </h3>
          <p class="mt-2 text-3xl font-bold">{pendingDevelopers.length}</p>
        </div>
        <div class="bg-card rounded-lg border p-6">
          <h3 class="text-muted-foreground text-sm font-medium">Verified</h3>
          <p class="mt-2 text-3xl font-bold">{verifiedDevelopers.length}</p>
        </div>
        <div class="bg-card rounded-lg border p-6">
          <h3 class="text-muted-foreground text-sm font-medium">Total</h3>
          <p class="mt-2 text-3xl font-bold">
            {pendingDevelopers.length + verifiedDevelopers.length}
          </p>
        </div>
      </div>

      <div class="space-y-8">
        <!-- Pending Developers -->
        <section>
          <h2 class="mb-4 text-2xl font-bold">Pending Verification</h2>
          {
            pendingDevelopers.length === 0 ? (
              <p class="text-muted-foreground">
                No developers pending verification.
              </p>
            ) : (
              <div class="space-y-4">
                {pendingDevelopers.map(dev => (
                  <div class="bg-card rounded-lg border p-6">
                    <div class="flex items-start justify-between">
                      <div class="flex gap-4">
                        <ProfileAvatar
                          src={dev.avatar}
                          name={dev.name}
                          username={dev.username}
                          size={64}
                          client:load
                        />
                        <div>
                          <h3 class="text-lg font-semibold">{dev.name}</h3>
                          <p class="text-muted-foreground text-sm">
                            @{dev.username}
                          </p>
                          {dev.bio && <p class="mt-2 text-sm">{dev.bio}</p>}
                          <div class="mt-2 flex gap-2">
                            {dev.github && (
                              <a
                                href={dev.github}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-primary text-sm hover:underline"
                              >
                                GitHub
                              </a>
                            )}
                            {dev.linkedin && (
                              <a
                                href={dev.linkedin}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-primary text-sm hover:underline"
                              >
                                LinkedIn
                              </a>
                            )}
                          </div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <ActionButton
                          action="approve"
                          developerId={dev.id}
                          variant="default"
                          size="sm"
                          className="bg-green-600 text-white hover:bg-green-700"
                          client:load
                        >
                          Approve
                        </ActionButton>
                        <ActionButton
                          action="reject"
                          developerId={dev.id}
                          variant="destructive"
                          size="sm"
                          client:load
                        >
                          Reject
                        </ActionButton>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )
          }
        </section>

        <!-- Verified Developers -->
        <section>
          <h2 class="mb-4 text-2xl font-bold">Verified Developers</h2>
          <div class="bg-card rounded-lg border p-6">
            <div class="space-y-2">
              {
                verifiedDevelopers.map(dev => (
                  <div class="flex items-center justify-between border-b py-2 last:border-b-0">
                    <div class="flex items-center gap-3">
                      <ProfileAvatar
                        src={dev.avatar}
                        name={dev.name}
                        username={dev.username}
                        size={40}
                        client:load
                      />
                      <div>
                        <p class="font-medium">{dev.name}</p>
                        <p class="text-muted-foreground text-sm">
                          @{dev.username}
                        </p>
                      </div>
                    </div>
                    <ActionButton
                      action="revoke"
                      developerId={dev.id}
                      variant="ghost"
                      size="sm"
                      className="text-destructive hover:text-destructive"
                      client:load
                    >
                      Revoke
                    </ActionButton>
                  </div>
                ))
              }
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</MainLayout>
