---
import { loadDevelopers } from "../../data/loadDevs";
import MainLayout from "../../components/MainLayout.astro";
import ProfileCard from "../../components/shared/ProfileCard";
import OnchainProfile from "../../components/onchain/OnchainProfile";
import WelcomeBanner from "../../components/shared/profile/WelcomeBanner";
import PendingVerificationBanner from "../../components/shared/profile/PendingVerificationBanner";
import { createSupabaseServerClient } from "../../lib/supabase/serverClient";
import { getDeveloperByUsername, getCurrentUser } from "../../lib/auth";

export const prerender = false;

const { username } = Astro.params;

// Try to get from Supabase first
const supabase = createSupabaseServerClient(Astro.cookies as any);
const currentUser = await getCurrentUser(supabase);
let developer = await getDeveloperByUsername(supabase, username || "");

// Check if user can view this profile
const isOwner =
  developer && currentUser && currentUser.id === developer.user_id;
if (developer) {
  // Profile exists in Supabase
  const isVerified = developer.is_verified;

  // Only show if verified OR if owner viewing their own profile
  if (!isVerified && !isOwner) {
    return Astro.redirect("/developers");
  }
}

// Check if this is a welcome redirect
const isWelcome = Astro.url.searchParams.get("welcome") === "true";

// Fallback to JSON if not found in Supabase
let dev: any;
if (!developer) {
  const developers = await loadDevelopers();
  dev = developers.find(d => d.username === username);

  if (!dev) {
    return Astro.redirect("/developers");
  }
} else {
  // Map database structure to component props
  dev = {
    name: developer.name,
    username: developer.username,
    avatar: developer.avatar || "",
    bio: developer.bio || "",
    github: developer.github || "",
    linkedin: developer.linkedin || "",
    telegram: developer.telegram || "",
    slushWallet: developer.slush_wallet || "",
    entry: developer.entry || "",
  };
}
---

<MainLayout title={`${dev.name} - Developer Profile`}>
  <div class="min-h-screen pt-20">
    <div class="container mx-auto px-4 py-8">
      <!-- Welcome Banner -->
      {isWelcome && isOwner && <WelcomeBanner client:only="react" />}

      <!-- Pending Verification Banner -->
      {
        isOwner && developer && !developer.is_verified && !isWelcome && (
          <PendingVerificationBanner client:only="react" />
        )
      }

      <!-- Profile Card -->
      <div class="mx-auto max-w-2xl">
        <div
          class="relative rounded-xl border border-white/10 bg-white/5 p-8 text-center backdrop-blur-sm"
        >
          <div id="static-profile" style="display:none">
            <ProfileCard
              client:only="react"
              variant="offchain"
              name={dev.name}
              username={dev.username}
              avatar={dev.avatar}
              bio={dev.bio}
              github={dev.github}
              linkedin={dev.linkedin}
              website={dev.website}
              walletAddress={dev.slushWallet}
              showEditButton={isOwner || undefined}
            />
          </div>

          <!-- On-chain profile overlay (Walrus JSON) -->
          <div id="onchain-profile">
            <OnchainProfile
              client:only="react"
              username={dev.username}
              showEditButton={isOwner || undefined}
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
